name: ğŸš€ íƒ€ë¡œ íƒ€ì´ë¨¸ ëª¨ë°”ì¼ ì•± ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_platform:
        description: 'ë¹Œë“œ í”Œë«í¼ ì„ íƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android
      deploy_to_store:
        description: 'ì•±ìŠ¤í† ì–´ ìë™ ì œì¶œ'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  EXPO_CLI_VERSION: 'latest'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ¥ Expo Doctor ê²€ì‚¬
        run: npx expo-doctor

      - name: ğŸ§¹ ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint || echo "ë¦°íŠ¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤"

      - name: ğŸ§ª íƒ€ì… ê²€ì‚¬
        run: npx tsc --noEmit || echo "TypeScript ì„¤ì • í™•ì¸ í•„ìš”"

  # ê°œë°œ ë¹Œë“œ (develop ë¸Œëœì¹˜)
  build-development:
    name: ğŸ› ï¸ ê°œë°œ ë¹Œë“œ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Expo CLI ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_CLI_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ—ï¸ ê°œë°œ ë¹Œë“œ ìƒì„±
        run: |
          npm run dev:env
          eas build --platform all --profile development --non-interactive

  # í”„ë¦¬ë·° ë¹Œë“œ (main ë¸Œëœì¹˜)
  build-preview:
    name: ğŸ¯ í”„ë¦¬ë·° ë¹Œë“œ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Expo CLI ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_CLI_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ—ï¸ í”„ë¦¬ë·° ë¹Œë“œ ìƒì„±
        run: |
          npm run prod:env
          eas build --platform all --profile preview --non-interactive

  # í”„ë¡œë•ì…˜ ë¹Œë“œ ë° ë°°í¬ (íƒœê·¸ ê¸°ë°˜)
  build-production:
    name: ğŸš€ í”„ë¡œë•ì…˜ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    outputs:
      ios-build-url: ${{ steps.build.outputs.ios-build-url }}
      android-build-url: ${{ steps.build.outputs.android-build-url }}

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Expo CLI ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_CLI_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ìƒì„±
        id: build
        run: |
          npm run prod:env

          # í”Œë«í¼ë³„ ë¹Œë“œ ì‹¤í–‰
          if [ "${{ github.event.inputs.build_platform }}" = "ios" ] || [ "${{ github.event.inputs.build_platform }}" = "all" ] || [ "${{ github.event.inputs.build_platform }}" = "" ]; then
            echo "ğŸ iOS ë¹Œë“œ ì‹œì‘..."
            eas build --platform ios --profile production-ios --non-interactive
          fi

          if [ "${{ github.event.inputs.build_platform }}" = "android" ] || [ "${{ github.event.inputs.build_platform }}" = "all" ] || [ "${{ github.event.inputs.build_platform }}" = "" ]; then
            echo "ğŸ¤– Android ë¹Œë“œ ì‹œì‘..."
            eas build --platform android --profile production-android --non-interactive
          fi

  # ì•±ìŠ¤í† ì–´ ìë™ ì œì¶œ
  submit-to-stores:
    name: ğŸ“± ì•±ìŠ¤í† ì–´ ì œì¶œ
    runs-on: ubuntu-latest
    needs: build-production
    if: |
      (startsWith(github.ref, 'refs/tags/v') ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_store == 'true'))

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Expo CLI ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_CLI_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ iOS App Store ì œì¶œ
        if: github.event.inputs.build_platform != 'android'
        run: eas submit --platform ios --latest --non-interactive
        continue-on-error: true

      - name: ğŸ¤– Google Play Store ì œì¶œ
        if: github.event.inputs.build_platform != 'ios'
        run: eas submit --platform android --latest --non-interactive
        continue-on-error: true

  # OTA ì—…ë°ì´íŠ¸ ë°°í¬
  deploy-ota-update:
    name: ğŸ“¡ OTA ì—…ë°ì´íŠ¸ ë°°í¬
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' &&
      !startsWith(github.ref, 'refs/tags/') &&
      contains(github.event.head_commit.message, '[ota]')

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Expo CLI ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_CLI_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¡ OTA ì—…ë°ì´íŠ¸ ë°°í¬
        run: |
          npm run prod:env
          eas update --channel production --message "${{ github.event.head_commit.message }}" --non-interactive

  # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
  create-release-notes:
    name: ğŸ“ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [build-production, submit-to-stores]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        id: release-notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          PREV_TAG=$(git describe --abbrev=0 --tags $TAG^ 2>/dev/null || echo "")

          echo "## ğŸ‰ íƒ€ë¡œ íƒ€ì´ë¨¸ $TAG ì¶œì‹œ" > release-notes.md
          echo "" >> release-notes.md
          echo "### ğŸ“± ë‹¤ìš´ë¡œë“œ" >> release-notes.md
          echo "- ğŸ [iOS App Store](https://apps.apple.com/app/tarot-timer)" >> release-notes.md
          echo "- ğŸ¤– [Google Play Store](https://play.google.com/store/apps/details?id=com.tarottimer.app)" >> release-notes.md
          echo "" >> release-notes.md

          if [ -n "$PREV_TAG" ]; then
            echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­ ($PREV_TAG...$TAG)" >> release-notes.md
            git log --pretty=format:"- %s" $PREV_TAG...$TAG >> release-notes.md
          else
            echo "### ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥" >> release-notes.md
            echo "- ğŸ•°ï¸ 24ì‹œê°„ íƒ€ë¡œ íƒ€ì´ë¨¸" >> release-notes.md
            echo "- ğŸ´ íƒ€ë¡œ ì¹´ë“œ ê¸°ë¡ ì‹œìŠ¤í…œ" >> release-notes.md
            echo "- ğŸ“” ì¼ê¸° ì‘ì„± ê¸°ëŠ¥" >> release-notes.md
            echo "- ğŸŒ ë‹¤êµ­ì–´ ì§€ì›" >> release-notes.md
            echo "- ğŸ“± í¬ë¡œìŠ¤ í”Œë«í¼ ì§€ì›" >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "### ğŸ”§ ê¸°ìˆ  ì •ë³´" >> release-notes.md
          echo "- **ë²„ì „**: $TAG" >> release-notes.md
          echo "- **ë¹Œë“œ ë‚ ì§œ**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> release-notes.md
          echo "- **ì»¤ë°‹**: ${GITHUB_SHA:0:7}" >> release-notes.md

      - name: ğŸ‰ GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: íƒ€ë¡œ íƒ€ì´ë¨¸ ${{ github.ref_name }}
          body_path: release-notes.md
          draft: false
          prerelease: false

  # ì•Œë¦¼ ë° ëª¨ë‹ˆí„°ë§
  notify-completion:
    name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-production, submit-to-stores, create-release-notes]
    if: always() && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“Š ë°°í¬ ê²°ê³¼ í™•ì¸
        run: |
          echo "ğŸ¯ ë°°í¬ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ"
          echo "ğŸ“¦ ë¹Œë“œ ìƒíƒœ: ${{ needs.build-production.result }}"
          echo "ğŸ“± ìŠ¤í† ì–´ ì œì¶œ: ${{ needs.submit-to-stores.result }}"
          echo "ğŸ“ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸: ${{ needs.create-release-notes.result }}"

          if [ "${{ needs.build-production.result }}" = "success" ]; then
            echo "âœ… ë¹Œë“œ ì„±ê³µ"
          else
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
          fi
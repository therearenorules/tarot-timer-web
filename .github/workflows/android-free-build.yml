name: Android Free Build (ë¬´ë£Œ ë¹Œë“œ)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ë¹Œë“œ íƒ€ì…'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
      version_bump:
        description: 'ë²„ì „ ìë™ ì¦ê°€'
        required: true
        default: true
        type: boolean

jobs:
  build-android:
    name: Android APK/AAB ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”¢ Version Bump (ìë™ ë²„ì „ ì¦ê°€)
        if: github.event.inputs.version_bump == 'true'
        run: |
          # app.jsonì—ì„œ í˜„ì¬ ë²„ì „ ì½ê¸°
          VERSION=$(node -p "require('./app.json').expo.version")
          BUILD_NUMBER=$(node -p "require('./app.json').expo.android.versionCode")

          # ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))

          # app.json ì—…ë°ì´íŠ¸
          node -e "
            const fs = require('fs');
            const appJson = require('./app.json');
            appJson.expo.android.versionCode = $NEW_BUILD_NUMBER;
            fs.writeFileSync('./app.json', JSON.stringify(appJson, null, 2));
          "

          echo "âœ… Version: $VERSION (Build $NEW_BUILD_NUMBER)"
          echo "NEW_BUILD_NUMBER=$NEW_BUILD_NUMBER" >> $GITHUB_ENV

      - name: ğŸ”§ Expo Prebuild
        run: |
          npx expo prebuild --platform android --clean

      - name: ğŸ” Setup Keystore (Release ì„œëª…)
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'apk'
        run: |
          # Keystore ìƒì„± (í”„ë¡œë•ì…˜ìš©)
          # ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” GitHub Secretsì— keystore íŒŒì¼ ì €ì¥ ê¶Œì¥
          cd android/app

          # GitHub Secretsì—ì„œ keystore ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
          if [ ! -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
            echo "âœ… Using existing keystore from secrets"
          else
            # Keystoreê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
            keytool -genkeypair -v \
              -storetype PKCS12 \
              -keystore release.keystore \
              -alias tarot-timer-key \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Tarot Timer, OU=Development, O=Tarot Timer Team, L=Seoul, ST=Seoul, C=KR"
            echo "âš ï¸ Generated new keystore for testing"
            echo "ğŸ”´ PRODUCTION: Replace with your actual keystore!"
          fi

      - name: ğŸ“ Configure Gradle for Release
        run: |
          cd android

          # gradle.propertiesì— ì„œëª… ì„¤ì • ì¶”ê°€
          cat >> gradle.properties <<EOF
          MYAPP_RELEASE_STORE_FILE=release.keystore
          MYAPP_RELEASE_KEY_ALIAS=tarot-timer-key
          MYAPP_RELEASE_STORE_PASSWORD=android
          MYAPP_RELEASE_KEY_PASSWORD=android
          EOF

          # build.gradle ì„œëª… ì„¤ì • í™•ì¸
          if ! grep -q "signingConfigs" app/build.gradle; then
            echo "âš ï¸ Warning: build.gradleì— signingConfigs ì„¤ì •ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi

      - name: ğŸ—ï¸ Build APK
        if: github.event.inputs.build_type == 'apk'
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

          echo "âœ… APK ë¹Œë“œ ì™„ë£Œ"
          ls -lh app/build/outputs/apk/release/

      - name: ğŸ—ï¸ Build AAB (App Bundle)
        if: github.event.inputs.build_type == 'aab'
        run: |
          cd android
          ./gradlew bundleRelease --no-daemon

          echo "âœ… AAB ë¹Œë“œ ì™„ë£Œ"
          ls -lh app/build/outputs/bundle/release/

      - name: ğŸ“¦ Rename Build Files
        run: |
          cd android/app/build/outputs

          if [ -f "apk/release/app-release.apk" ]; then
            BUILD_NUM="${{ env.NEW_BUILD_NUMBER }}"
            if [ -z "$BUILD_NUM" ]; then
              BUILD_NUM=$(date +%Y%m%d-%H%M)
            fi
            mv apk/release/app-release.apk apk/release/tarot-timer-v${BUILD_NUM}.apk
            echo "âœ… Renamed APK: tarot-timer-v${BUILD_NUM}.apk"
          fi

          if [ -f "bundle/release/app-release.aab" ]; then
            BUILD_NUM="${{ env.NEW_BUILD_NUMBER }}"
            if [ -z "$BUILD_NUM" ]; then
              BUILD_NUM=$(date +%Y%m%d-%H%M)
            fi
            mv bundle/release/app-release.aab bundle/release/tarot-timer-v${BUILD_NUM}.aab
            echo "âœ… Renamed AAB: tarot-timer-v${BUILD_NUM}.aab"
          fi

      - name: ğŸ“¤ Upload APK
        if: github.event.inputs.build_type == 'apk'
        uses: actions/upload-artifact@v4
        with:
          name: tarot-timer-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ğŸ“¤ Upload AAB
        if: github.event.inputs.build_type == 'aab'
        uses: actions/upload-artifact@v4
        with:
          name: tarot-timer-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ‰ Android ë¹Œë“œ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë¹Œë“œ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ íƒ€ì…**: ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: $(node -p "require('./app.json').expo.version")" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë²ˆí˜¸**: $(node -p "require('./app.json').expo.android.versionCode")" >> $GITHUB_STEP_SUMMARY
          echo "- **ë‚ ì§œ**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ ë‹¤ìš´ë¡œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "Actions íƒ­ â†’ Artifactsì—ì„œ ë¹Œë“œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.build_type }}" == "apk" ]; then
            APK_SIZE=$(du -h android/app/build/outputs/apk/release/*.apk | cut -f1)
            echo "- **APK í¬ê¸°**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          else
            AAB_SIZE=$(du -h android/app/build/outputs/bundle/release/*.aab | cut -f1)
            echo "- **AAB í¬ê¸°**: $AAB_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¾ Commit Version Bump
        if: github.event.inputs.version_bump == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app.json
          git commit -m "chore: Android ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€ â†’ ${{ env.NEW_BUILD_NUMBER }}" || echo "No changes to commit"
          git push || echo "Push failed - check permissions"

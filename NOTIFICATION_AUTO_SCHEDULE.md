# 🔔 알림 자동 스케줄링 시스템

## 📋 개요

24시간 타로 카드 뽑기 후 자동으로 알림이 스케줄링되도록 개선되었습니다.

**업데이트 날짜**: 2025-10-08

---

## ✅ 구현된 기능

### 1. **카드 뽑기 후 자동 알림 재스케줄링**

#### 변경 사항
- **파일**: `hooks/useTarotCards.ts`
- **함수**: `performDrawDailyCards()`, `redrawAllCards()`

#### 작동 방식
```typescript
// 24시간 카드 뽑기 완료 후
const newCards = TarotUtils.getRandomCardsNoDuplicates(24);
await saveDailyCards(newCards, {});

// ✅ 자동으로 알림 재스케줄링
if (hasPermission && scheduleHourlyNotifications) {
  await scheduleHourlyNotifications();
  // → 새로운 카드 정보로 알림 메시지 업데이트
}
```

#### 결과
- 카드를 뽑으면 즉시 24개 시간별 알림이 생성됨
- 각 알림에는 해당 시간의 **실제 카드 정보**가 포함됨
- 다국어 지원 (한/영/일)

---

### 2. **자정 초기화 시 알림 정리**

#### 변경 사항
- **파일**: `hooks/useTarotCards.ts`
- **함수**: `handleMidnightReset()`

#### 작동 방식
```typescript
// 자정(00:00)이 되면
handleMidnightReset() {
  // 1. 카드 상태 초기화
  setDailyCards([]);

  // 2. ✅ 기존 알림 모두 취소
  cancelHourlyNotifications();

  // 3. 새로운 날짜로 데이터 로드
  loadTodayCards();
}
```

#### 결과
- 자정에 어제의 알림이 자동으로 취소됨
- 사용자가 새 카드를 뽑으면 새로운 알림이 생성됨
- 오래된 알림이 계속 울리는 문제 해결

---

## 🔄 전체 플로우

### **시나리오 1: 첫 카드 뽑기**
```
1. 앱 실행
2. "24시간 카드 뽑기" 버튼 클릭
3. 24개 카드 생성 ✅
4. 자동으로 24개 알림 스케줄링 ✅
   - 각 알림에 실제 카드 정보 포함
   - 조용한 시간(22:00-08:00) 제외
5. 완료 메시지 표시
```

### **시나리오 2: 카드 다시 뽑기**
```
1. "다시 뽑기" 버튼 클릭
2. 확인 다이얼로그
3. 24개 카드 재생성 ✅
4. 기존 알림 취소 후 재스케줄링 ✅
   - 새로운 카드 정보로 업데이트
5. 완료
```

### **시나리오 3: 자정 초기화**
```
23:59 - 24시간 카드 & 알림 활성화
  ↓
00:00 - 자정 감지
  ↓
  🌙 카드 상태 초기화
  🔕 알림 모두 취소
  ↓
  사용자가 새 카드 뽑기
  ↓
  🔔 새로운 알림 자동 생성
```

---

## 📱 알림 메시지 예시

### **카드 정보가 있을 때**
```
🔮 타로 타이머

[14시] 여교황 - 직관과 내면의 지혜
```

### **카드를 아직 안 뽑았을 때**
```
🔮 타로 타이머

새로운 타로 카드를 뽑을 시간입니다!
```

### **다국어 지원**
- **한국어**: `[14시] 여교황 - 직관과 내면의 지혜`
- **영어**: `[2PM] The High Priestess - Intuition and inner wisdom`
- **일본어**: `[14時] 女教皇 - 直感と内なる知恵`

---

## 🎯 기술적 세부사항

### **의존성 추가**
```typescript
// hooks/useTarotCards.ts
import { useNotifications } from '../contexts/NotificationContext';
```

### **조건부 실행**
- **웹 환경**: 알림 스케줄링 스킵 (웹은 푸시 알림 미지원)
- **모바일**: iOS/Android에서만 실행
- **권한 없음**: 알림 스케줄링 스킵 (에러 없음)

### **에러 처리**
```typescript
try {
  await scheduleHourlyNotifications();
  console.log('✅ 알림 업데이트 완료');
} catch (error) {
  console.warn('⚠️ 알림 실패 (무시 가능)');
  // 카드 뽑기는 성공으로 처리
}
```

---

## 🧪 테스트 방법

### **1. 카드 뽑기 후 알림 확인**
```
1. 앱에서 "24시간 카드 뽑기" 클릭
2. 콘솔 확인:
   "🔔 새 카드 뽑기 완료 - 알림 재스케줄링 시작"
   "✅ 새 카드 정보로 알림 업데이트 완료"
3. 설정 > 예약된 알림 확인
4. 24개 알림이 생성되었는지 확인
5. 각 알림 메시지에 카드 정보 포함 확인
```

### **2. 자정 초기화 테스트**
```
1. 23:58에 카드 뽑기
2. 앱 계속 실행
3. 00:00 자정 대기
4. 콘솔 확인:
   "🔕 자정 초기화 - 기존 알림 취소"
   "✅ 알림 취소 완료"
5. 설정 > 예약된 알림 확인
6. 알림이 0개인지 확인
7. 새 카드 뽑기 → 새 알림 생성 확인
```

### **3. 다시 뽑기 테스트**
```
1. 카드 뽑기
2. "다시 뽑기" 버튼 클릭
3. 콘솔 확인:
   "🔔 카드 다시 뽑기 완료 - 알림 재스케줄링 시작"
4. 알림 메시지가 새 카드로 업데이트되었는지 확인
```

---

## ⚠️ 알려진 제약사항

1. **웹 환경**
   - 웹에서는 푸시 알림 미지원
   - 알림 스케줄링 코드는 실행되지 않음 (정상)

2. **권한 없음**
   - 알림 권한이 없으면 스케줄링 스킵
   - 사용자가 설정에서 권한 허용 필요

3. **iOS 제약**
   - iOS는 최대 64개 예약 알림 제한
   - 현재: 24개 시간별 + 1개 자정 = 25개 (여유 있음)

---

## 📊 개선 전/후 비교

| 항목 | 개선 전 ❌ | 개선 후 ✅ |
|------|-----------|-----------|
| **카드 뽑기 후 알림** | 수동 설정 필요 | 자동 생성 |
| **알림 메시지** | 기본 메시지만 | 실제 카드 정보 포함 |
| **자정 초기화** | 알림 유지 (오류) | 알림 자동 취소 |
| **다시 뽑기** | 알림 업데이트 안 됨 | 자동 재스케줄링 |
| **사용자 경험** | 불편함 | 완전 자동화 |

---

## 🚀 향후 개선 가능 사항

1. **개별 카드 다시 뽑기 시 알림 업데이트**
   - 현재: 전체 카드 뽑기만 알림 재생성
   - 개선: 개별 카드 변경 시 해당 시간 알림만 업데이트

2. **알림 커스터마이징**
   - 사용자가 알림 메시지 형식 선택
   - 카드 의미 전체 표시 옵션

3. **알림 히스토리**
   - 받은 알림 기록 저장
   - 알림 클릭 시 해당 카드로 이동

---

**마지막 업데이트**: 2025-10-08
**담당자**: Claude Code
**상태**: ✅ 완료 및 테스트 가능

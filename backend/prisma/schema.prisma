// Tarot Timer Backend - Database Schema
// Based on BACKEND_DEVELOPMENT_PLAN.md requirements

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User management table - Enhanced for production requirements
model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Subscription management - Following BACKEND_DEVELOPMENT_PLAN.md spec
  subscriptionStatus   String   @default("trial") @map("subscription_status")
  trialStartDate       DateTime @default(now()) @map("trial_start_date")
  trialEndDate         DateTime @map("trial_end_date")

  // Localization and preferences
  language             String   @default("ko")
  timezone             String   @default("Asia/Seoul")
  activeCardThemeId    String?  @map("active_card_theme_id")

  // Stripe integration fields
  stripeCustomerId     String?  @unique @map("stripe_customer_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")

  // Usage tracking
  totalSessions        Int      @default(0) @map("total_sessions")
  lastActive           DateTime @default(now()) @map("last_active")

  // Relations
  dailySessions        DailyTarotSession[]
  spreadReadings       SpreadReading[]
  themeOwnership       UserThemeOwnership[]
  cardTheme            CardTheme? @relation(fields: [activeCardThemeId], references: [id])
  analytics            UserAnalytic[]
  adImpressions        AdImpression[]

  @@map("users")
}

// Daily 24-hour tarot sessions - Core feature matching existing interface
model DailyTarotSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime

  // JSON structure as TEXT for SQLite compatibility
  cards     String   // JSON Array of 24 TarotCard objects for each hour
  memos     String   @default("{}") // JSON Object with hour indices as keys
  insights  String?  // Overall daily insights

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one session per user per date
  @@unique([userId, date])
  @@map("daily_tarot_sessions")
}

// Tarot spread readings storage - Matching existing SavedSpread interface
model SpreadReading {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")

  title       String
  spreadType  String   @map("spread_type")
  spreadName  String   @map("spread_name")
  spreadNameEn String  @map("spread_name_en")

  // JSON structure as TEXT for SQLite compatibility
  positions   String   // JSON Array of SpreadPosition objects with cards
  insights    String?

  // Metadata
  tags        String   @default("[]") // JSON array as string
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([spreadType])
  @@map("spread_readings")
}

// Card theme system for monetization
model CardTheme {
  id              String   @id @default(cuid())

  name            String
  nameKr          String   @map("name_kr")
  nameEn          String   @map("name_en")
  nameJa          String?  @map("name_ja") // Future Japanese support

  description     String
  descriptionKr   String   @map("description_kr")
  descriptionEn   String   @map("description_en")
  descriptionJa   String?  @map("description_ja")

  // Pricing and availability
  price           Float
  isActive        Boolean  @default(true) @map("is_active")
  isDefault       Boolean  @default(false) @map("is_default")

  // Theme metadata
  style           String   // 'mystical', 'modern', 'vintage', etc.
  cardAssets      String   // JSON object mapping card IDs to asset URLs
  thumbnailUrl    String   @map("thumbnail_url")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  userOwnership   UserThemeOwnership[]
  activeUsers     User[]

  @@map("card_themes")
}

// User theme ownership tracking
model UserThemeOwnership {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  cardThemeId   String    @map("card_theme_id")

  // Purchase information
  purchasedAt   DateTime  @default(now()) @map("purchased_at")
  purchasePrice Float     @map("purchase_price")

  // Stripe tracking
  stripePaymentIntentId String? @map("stripe_payment_intent_id")

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cardTheme     CardTheme @relation(fields: [cardThemeId], references: [id], onDelete: Cascade)

  // Ensure one ownership record per user per theme
  @@unique([userId, cardThemeId])
  @@map("user_theme_ownership")
}

// Subscription management
model Subscription {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")

  // Stripe subscription details
  stripeSubscriptionId  String   @unique @map("stripe_subscription_id")
  stripePriceId         String   @map("stripe_price_id")
  stripeCustomerId      String   @map("stripe_customer_id")

  // Subscription status and timing
  status                String   // 'active', 'canceled', 'past_due', etc.
  currentPeriodStart    DateTime @map("current_period_start")
  currentPeriodEnd      DateTime @map("current_period_end")

  // Billing
  plan                  String   // 'monthly', 'yearly'
  amount                Float
  currency              String   @default("usd")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  canceledAt            DateTime? @map("canceled_at")

  @@map("subscriptions")
}

// Analytics tracking (privacy-first, anonymized)
model UserAnalytic {
  id                String   @id @default(cuid())

  // Anonymous user tracking - SHA-256 hash for privacy
  userHash          String   @map("user_hash")
  userId            String?  @map("user_id") // Optional for user-specific analytics

  // Event tracking
  eventType         String   @map("event_type")
  eventData         String   @default("{}") // JSON as TEXT

  // Session information
  sessionId         String?  @map("session_id")
  userAgent         String?  @map("user_agent")

  // Localization
  language          String   @default("ko")
  timezone          String   @default("Asia/Seoul")

  // Timestamp
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations (optional)
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Retention policy - data older than 90 days will be purged
  @@index([createdAt])
  @@index([eventType])
  @@map("user_analytics")
}

// Ad impression tracking for monetization
model AdImpression {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  adPlacement String   @map("ad_placement") // 'banner', 'interstitial', 'rewarded'
  adNetwork   String?  @map("ad_network")  // 'admob', 'meta', etc.
  revenue     Float    @default(0.0)
  displayedAt DateTime @default(now()) @map("displayed_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, displayedAt])
  @@map("ad_impressions")
}

// System configuration and feature flags
model SystemConfig {
  id            String   @id @default(cuid())

  key           String   @unique
  value         String   // JSON as TEXT
  description   String?

  // Metadata
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}